<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ˜¶é’ç‰©æµ æ™ºèƒ½å®¢æœå¼•å°ç³»çµ±</title>
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    body { 
      font-family: 'Microsoft JhengHei', sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh; 
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .header { 
      background: linear-gradient(45deg, #2196F3, #21CBF3);
      color: white; 
      padding: 15px 20px; 
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 100;
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .header p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .session-info {
      background: rgba(255,255,255,0.1);
      padding: 8px 15px;
      border-radius: 20px;
      margin-top: 10px;
      font-size: 12px;
      display: inline-block;
    }
    
    .chat-container { 
      flex: 1;
      overflow-y: auto; 
      padding: 20px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
    }
    
    .message { 
      margin: 15px 0; 
      padding: 15px 20px; 
      border-radius: 20px; 
      max-width: 85%; 
      animation: fadeIn 0.4s ease-out;
      line-height: 1.6;
      word-wrap: break-word;
    }
    
    .user-message { 
      background: linear-gradient(135deg, #2196F3, #1976D2);
      color: white; 
      margin-left: auto; 
      text-align: right;
      box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
    }
    
    .assistant-message { 
      background: white;
      border: 1px solid #e0e0e0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .assistant-message::before {
      content: 'ğŸ¤–';
      position: absolute;
      left: -10px;
      top: -5px;
      background: #2196F3;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    
    .input-area { 
      padding: 20px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.3);
    }
    
    .input-group { 
      display: flex; 
      gap: 15px; 
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    #userInput { 
      flex: 1; 
      padding: 15px 25px; 
      border: 2px solid #e0e0e0; 
      border-radius: 30px;
      font-size: 16px; 
      outline: none; 
      transition: all 0.3s;
      background: white;
    }
    
    #userInput:focus { 
      border-color: #2196F3; 
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }
    
    .send-btn { 
      background: linear-gradient(135deg, #2196F3, #1976D2);
      color: white; 
      border: none; 
      padding: 15px 25px; 
      border-radius: 30px; 
      cursor: pointer;
      font-weight: bold; 
      transition: all 0.3s;
      font-size: 16px;
      min-width: 80px;
    }
    
    .send-btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
    }
    
    .send-btn:disabled { 
      background: #ccc; 
      cursor: not-allowed; 
      transform: none;
      box-shadow: none;
    }
    
    .loading { 
      display: flex; 
      align-items: center; 
      gap: 10px;
      color: #666; 
      font-style: italic;
    }
    
    .typing-indicator { 
      display: inline-flex; 
      gap: 4px;
    }
    
    .typing-dot { 
      width: 8px; 
      height: 8px; 
      background: #2196F3; 
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
      0%, 80%, 100% { 
        transform: scale(0); 
        opacity: 0.5; 
      }
      40% { 
        transform: scale(1); 
        opacity: 1; 
      }
    }
    
    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(20px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
    
    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      .header h1 { font-size: 20px; }
      .header p { font-size: 12px; }
      .message { max-width: 95%; }
      .input-area { padding: 15px; }
      #userInput { font-size: 16px; }
      .send-btn { padding: 12px 20px; }
    }
    
    /* æ»¾å‹•æ¢ç¾åŒ– */
    .chat-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .chat-container::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.1);
      border-radius: 3px;
    }
    
    .chat-container::-webkit-scrollbar-thumb {
      background: rgba(33, 150, 243, 0.5);
      border-radius: 3px;
    }
    
    .chat-container::-webkit-scrollbar-thumb:hover {
      background: rgba(33, 150, 243, 0.8);
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸšš æ˜¶é’ç‰©æµæ™ºèƒ½å®¢æœ</h1>
    <p>æˆ‘å°‡å¼•å°æ‚¨è§£æ±ºå•é¡Œï¼Œè«‹è©³ç´°å›ç­”æ¯å€‹å•é¡Œ</p>
    <div class="session-info">
      <strong>å°è©±ç·¨è™Ÿï¼š</strong><span id="sessionId"></span> | 
      <strong>é–‹å§‹æ™‚é–“ï¼š</strong><span id="startTime"></span>
    </div>
  </div>
  
  <div class="chat-container" id="chatContainer">
    <div class="message assistant-message">
      ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ˜¶é’ç‰©æµçš„æ™ºèƒ½å®¢æœåŠ©ç†ã€‚<br>
      è«‹å‘Šè¨´æˆ‘æ‚¨é‡åˆ°ä»€éº¼å•é¡Œï¼Œæˆ‘æœƒé€æ­¥å¼•å°æ‚¨æ‰¾åˆ°è§£æ±ºæ–¹æ¡ˆã€‚
    </div>
  </div>
  
  <div class="input-area">
    <div class="input-group">
      <input type="text" id="userInput" placeholder="è«‹æè¿°æ‚¨çš„å•é¡Œ..." 
             onkeypress="handleKeyPress(event)">
      <button class="send-btn" onclick="sendMessage()" id="sendBtn">
        ç™¼é€
      </button>
    </div>
  </div>

  <script>
    const CONFIG = {
      GAS_URL: 'const CONFIG = {
  AI_MODEL: 'gpt-4o',
  AI_MAX_TOKENS: 2048,
  AI_TEMPERATURE: 0.7,
  KNOWLEDGE_SHEET: 'çŸ¥è­˜åº«',
  CUSTOMER_SHEET: 'å®¢æˆ¶å›ç­”',
  CACHE_DURATION: 1800,
  MAX_HISTORY_LENGTH: 20,
  CONVERSATION_THRESHOLD: 6 // å°è©±è¼ªæ¬¡é”åˆ°æ­¤æ•¸é‡å¾Œè¦æ±‚è¯çµ¡è³‡è¨Š
};

function doGet(e) {
  const callback = e.parameter.callback || 'callback';
  
  try {
    const action = e.parameter.action;
    let result = {};
    
    switch (action) {
      case 'guided_chat':
        result = handleGuidedChat(e.parameter);
        break;
      default:
        throw new Error('ä¸æ”¯æ´çš„æ“ä½œé¡å‹');
    }
    
    return ContentService
      .createTextOutput(`${callback}(${JSON.stringify(result)})`)
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
      
  } catch (error) {
    console.error('è™•ç†è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    return ContentService
      .createTextOutput(`${callback}(${JSON.stringify({
        success: false,
        error: error.message
      })})`)
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
}

function handleGuidedChat(params) {
  const message = params.message || '';
  const history = params.history ? JSON.parse(params.history) : [];
  const sessionId = params.sessionId || '';
  
  if (!message.trim()) {
    throw new Error('è¨Šæ¯å…§å®¹ä¸èƒ½ç‚ºç©º');
  }
  
  try {
    // 1. ç²å–çŸ¥è­˜åº«è³‡æ–™
    const knowledgeBase = getKnowledgeBase();
    
    // 2. ç”Ÿæˆå¼•å°å¼å›æ‡‰
    const response = generateGuidedResponse(message, history, knowledgeBase);
    
    // 3. æª¢æŸ¥æ˜¯å¦éœ€è¦è¦æ±‚è¯çµ¡è³‡è¨Š
    const shouldRequestContact = checkShouldRequestContact(history, message);
    
    // 4. è¨˜éŒ„å®¢æˆ¶å°è©± (åŒä¸€æœƒè©±IDçš„å°è©±åˆä½µ)
    recordCustomerConversation(sessionId, message, response, history, shouldRequestContact);
    
    return {
      success: true,
      answer: response,
      sessionId: sessionId,
      shouldRequestContact: shouldRequestContact
    };
    
  } catch (error) {
    console.error('è™•ç†å¼•å°å°è©±æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
    throw new Error('ç³»çµ±è™•ç†å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
}

function generateGuidedResponse(userMessage, history, knowledgeBase) {
  const apiKey = getConfig('OPENAI_API_KEY');
  
  // æ§‹å»ºçŸ¥è­˜åº«æç¤º
  let knowledgePrompt = "ä»¥ä¸‹æ˜¯æ˜¶é’ç‰©æµçš„å®¢æœçŸ¥è­˜åº«ï¼Œæ¯å€‹é …ç›®åŒ…å«å•é¡Œåˆ†é¡ã€è§£æ±ºæ­¥é©Ÿï¼š\n\n";
  
  knowledgeBase.forEach((item, index) => {
    knowledgePrompt += `${index + 1}. ã€${item.category}ã€‘\n`;
    knowledgePrompt += `   å•é¡Œé¡å‹ï¼š${item.question}\n`;
    knowledgePrompt += `   è™•ç†æ­¥é©Ÿï¼š${item.steps}\n\n`;
  });
  
  const systemPrompt = `ä½ æ˜¯æ˜¶é’ç‰©æµçš„å°ˆæ¥­å®¢æœåŠ©ç†ï¼Œè«‹æ ¹æ“šçŸ¥è­˜åº«ä¸­çš„è™•ç†æ­¥é©Ÿä¾†å¼•å°å®¢æˆ¶ã€‚

é‡è¦æŒ‡ç¤ºï¼š
1. ä¸è¦ç›´æ¥è¤‡è£½è²¼ä¸ŠçŸ¥è­˜åº«çš„æ­¥é©Ÿå…§å®¹
2. è¦æ¶ˆåŒ–ç†è§£æ­¥é©Ÿå¾Œï¼Œç”¨å¼•å°å¼å•ç­”æ–¹å¼å”åŠ©å®¢æˆ¶
3. ä¸€æ¬¡åªå•1-2å€‹é—œéµå•é¡Œï¼Œå¾ªåºæ¼¸é€²
4. æ ¹æ“šå®¢æˆ¶å›ç­”åˆ¤æ–·ä¸‹ä¸€æ­¥è©²å•ä»€éº¼
5. èªæ°£è¦è¦ªåˆ‡å°ˆæ¥­ï¼Œè®“å®¢æˆ¶æ„Ÿå—åˆ°è¢«é‡è¦–
6. å¦‚æœå®¢æˆ¶æä¾›çš„è³‡è¨Šä¸è¶³ï¼Œè¦ä¸»å‹•è©¢å•å¿…è¦ç´°ç¯€
7. ç•¶å•é¡ŒåŸºæœ¬è§£æ±ºæˆ–å®¢æˆ¶éœ€æ±‚æ˜ç¢ºå¾Œï¼Œè¦è‡ªç„¶åœ°çµæŸå°è©±
8. ä¸è¦ä¸»å‹•è¦æ±‚å®¢æˆ¶æä¾›è¯çµ¡è³‡è¨Šï¼Œç³»çµ±æœƒè‡ªå‹•è™•ç†

çŸ¥è­˜åº«å…§å®¹ï¼š
${knowledgePrompt}

è«‹æ ¹æ“šå°è©±æ­·å²å’Œå®¢æˆ¶æœ€æ–°è¨Šæ¯ï¼Œæä¾›ä¸‹ä¸€æ­¥çš„å¼•å°å•é¡Œæˆ–è§£æ±ºæ–¹æ¡ˆã€‚`;

  // é™åˆ¶æ­·å²è¨˜éŒ„é•·åº¦
  const limitedHistory = history.slice(-CONFIG.MAX_HISTORY_LENGTH);
  
  const messages = [
    { role: 'system', content: systemPrompt },
    ...limitedHistory,
    { role: 'user', content: userMessage }
  ];
  
  try {
    const response = UrlFetchApp.fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json'
      },
      payload: JSON.stringify({
        model: CONFIG.AI_MODEL,
        messages: messages,
        max_tokens: CONFIG.AI_MAX_TOKENS,
        temperature: CONFIG.AI_TEMPERATURE
      })
    });
    
    const data = JSON.parse(response.getContentText());
    
    if (data.choices && data.choices.length > 0) {
      return data.choices[0].message.content.trim();
    } else {
      throw new Error('AI æœå‹™ç„¡å›æ‡‰');
    }
    
  } catch (error) {
    console.error('èª¿ç”¨ OpenAI API å¤±æ•—:', error);
    throw new Error('AI æœå‹™æš«æ™‚ä¸å¯ç”¨');
  }
}

function checkShouldRequestContact(history, currentMessage) {
  // æª¢æŸ¥å°è©±è¼ªæ¬¡æ˜¯å¦é”åˆ°é–¾å€¼
  const userMessages = history.filter(msg => msg.role === 'user').length + 1;
  
  // æª¢æŸ¥æ˜¯å¦åŒ…å«è¯çµ¡è³‡è¨Šé—œéµå­—
  const contactKeywords = ['å…¬å¸', 'è¯çµ¡', 'é›»è©±', 'æ‰‹æ©Ÿ', 'ä¿¡ç®±', 'email', 'åœ°å€', 'è¯ç¹«'];
  const hasContactInfo = contactKeywords.some(keyword => 
    currentMessage.toLowerCase().includes(keyword)
  );
  
  // å¦‚æœå·²ç¶“æä¾›è¯çµ¡è³‡è¨Šï¼Œä¸å†è¦æ±‚
  if (hasContactInfo) {
    return false;
  }
  
  // é”åˆ°å°è©±é–¾å€¼ä¸”å•é¡Œä¼¼ä¹å·²è§£æ±º
  return userMessages >= CONFIG.CONVERSATION_THRESHOLD;
}

function recordCustomerConversation(sessionId, userMessage, assistantResponse, fullHistory, shouldRequestContact) {
  try {
    const sheetId = getConfig('SHEET_ID');
    const spreadsheet = SpreadsheetApp.openById(sheetId);
    
    // ç²å–æˆ–å‰µå»ºå®¢æˆ¶å›ç­”å·¥ä½œè¡¨
    let sheet = spreadsheet.getSheetByName(CONFIG.CUSTOMER_SHEET);
    if (!sheet) {
      sheet = spreadsheet.insertSheet(CONFIG.CUSTOMER_SHEET);
      // è¨­ç½®æ¨™é¡Œè¡Œ
      sheet.getRange(1, 1, 1, 5).setValues([['æ™‚é–“', 'å°è©±è¨˜éŒ„', 'æœƒè©±ID', 'å®Œæ•´æ­·å²', 'è¯çµ¡è³‡è¨Š']]);
      sheet.getRange(1, 1, 1, 5).setFontWeight('bold');
      sheet.setFrozenRows(1);
    }
    
    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæœƒè©±IDçš„è¨˜éŒ„
    const data = sheet.getDataRange().getValues();
    let existingRowIndex = -1;
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][2] === sessionId) { // Cæ¬„æ˜¯æœƒè©±ID
        existingRowIndex = i + 1; // è½‰æ›ç‚ºå·¥ä½œè¡¨è¡Œè™Ÿ
        break;
      }
    }
    
    // æº–å‚™æ–°çš„å°è©±è¨˜éŒ„
    const newConversation = `ç”¨æˆ¶ï¼š${userMessage}\nåŠ©ç†ï¼š${assistantResponse}`;
    const timestamp = new Date();
    const historyJson = JSON.stringify([...fullHistory, 
      { role: 'user', content: userMessage },
      { role: 'assistant', content: assistantResponse }
    ], null, 2);
    
    if (existingRowIndex > 0) {
      // æ›´æ–°ç¾æœ‰è¨˜éŒ„ - åˆä½µå°è©±å…§å®¹
      const existingConversation = sheet.getRange(existingRowIndex, 2).getValue();
      const updatedConversation = existingConversation + '\n\n' + newConversation;
      
      // æ›´æ–°æ™‚é–“ã€å°è©±è¨˜éŒ„å’Œå®Œæ•´æ­·å²
      sheet.getRange(existingRowIndex, 1).setValue(timestamp);
      sheet.getRange(existingRowIndex, 2).setValue(updatedConversation);
      sheet.getRange(existingRowIndex, 4).setValue(historyJson);
      
      // å¦‚æœéœ€è¦è¦æ±‚è¯çµ¡è³‡è¨Šï¼Œæ·»åŠ åˆ°Eæ¬„
      if (shouldRequestContact) {
        const contactRequest = "è«‹å‘Šè¨´æˆ‘æ‚¨çš„å…¬å¸åç¨±åŠè¯çµ¡æ–¹å¼ï¼Œæˆ‘å€‘æœƒæœ‰å°ˆäººèˆ‡æ‚¨è¯ç¹«ï¼";
        sheet.getRange(existingRowIndex, 5).setValue(contactRequest);
      }
      
    } else {
      // å‰µå»ºæ–°è¨˜éŒ„
      const contactInfo = shouldRequestContact ? "è«‹å‘Šè¨´æˆ‘æ‚¨çš„å…¬å¸åç¨±åŠè¯çµ¡æ–¹å¼ï¼Œæˆ‘å€‘æœƒæœ‰å°ˆäººèˆ‡æ‚¨è¯ç¹«ï¼" : "";
      
      sheet.appendRow([
        timestamp,
        newConversation,
        sessionId,
        historyJson,
        contactInfo
      ]);
    }
    
    // è‡ªå‹•èª¿æ•´æ¬„ä½å¯¬åº¦
    sheet.autoResizeColumns(1, 5);
    
    // è¨­ç½®æ–‡å­—æ›è¡Œ
    const lastRow = sheet.getLastRow();
    sheet.getRange(lastRow, 2).setWrap(true); // Bæ¬„å°è©±è¨˜éŒ„
    sheet.getRange(lastRow, 4).setWrap(true); // Dæ¬„å®Œæ•´æ­·å²
    sheet.getRange(lastRow, 5).setWrap(true); // Eæ¬„è¯çµ¡è³‡è¨Š
    
  } catch (error) {
    console.error('è¨˜éŒ„å®¢æˆ¶å°è©±å¤±æ•—:', error);
    // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œé¿å…å½±éŸ¿ä¸»è¦åŠŸèƒ½
  }
}

function getKnowledgeBase() {
  try {
    const sheetId = getConfig('SHEET_ID');
    const sheet = SpreadsheetApp.openById(sheetId).getSheetByName(CONFIG.KNOWLEDGE_SHEET);
    
    if (!sheet) {
      throw new Error(`æ‰¾ä¸åˆ°å·¥ä½œè¡¨ï¼š${CONFIG.KNOWLEDGE_SHEET}`);
    }
    
    const values = sheet.getDataRange().getValues();
    const knowledgeBase = [];
    
    // è·³éæ¨™é¡Œè¡Œï¼Œå¾ç¬¬äºŒè¡Œé–‹å§‹è®€å–
    for (let i = 1; i < values.length; i++) {
      const [question, steps, category, priority] = values[i];
      
      if (question && steps) {
        knowledgeBase.push({
          question: question.toString().trim(),
          steps: steps.toString().trim(),
          category: category ? category.toString().trim() : 'ä¸€èˆ¬å•é¡Œ',
          priority: priority || 1
        });
      }
    }
    
    // æŒ‰å„ªå…ˆç´šæ’åº
    knowledgeBase.sort((a, b) => (b.priority || 1) - (a.priority || 1));
    
    return knowledgeBase.slice(0, 15); // é™åˆ¶æ•¸é‡é¿å… token è¶…é™
    
  } catch (error) {
    console.error('è®€å–çŸ¥è­˜åº«å¤±æ•—:', error);
    throw new Error('ç„¡æ³•è®€å–çŸ¥è­˜åº«è³‡æ–™');
  }
}

function getConfig(key) {
  const properties = PropertiesService.getScriptProperties();
  const value = properties.getProperty(key);
  
  if (!value) {
    throw new Error(`ç¼ºå°‘å¿…è¦çš„è¨­å®šåƒæ•¸ï¼š${key}`);
  }
  
  return value;
}
'
    };

    let chatHistory = [];
    let sessionId = '';
    let isProcessing = false;
    let conversationEnded = false;

    // åˆå§‹åŒ–æœƒè©±
    function initSession() {
      sessionId = 'CS_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
      const startTime = new Date().toLocaleString('zh-TW');
      document.getElementById('sessionId').textContent = sessionId;
      document.getElementById('startTime').textContent = startTime;
    }

    // ç™¼é€è¨Šæ¯
    async function sendMessage() {
      const input = document.getElementById('userInput');
      const message = input.value.trim();
      
      if (!message || isProcessing) return;
      
      // é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
      addMessage(message, 'user');
      input.value = '';
      
      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      showLoading();
      isProcessing = true;
      
      try {
        const response = await makeRequest({
          action: 'guided_chat',
          message: message,
          history: chatHistory,
          sessionId: sessionId
        });
        
        hideLoading();
        
        if (response.success) {
          // è¨˜éŒ„å°è©±æ­·å²
          chatHistory.push({ role: 'user', content: message });
          chatHistory.push({ role: 'assistant', content: response.answer });
          
          // é¡¯ç¤ºåŠ©ç†å›æ‡‰
          addMessage(response.answer, 'assistant');
          
          // æª¢æŸ¥æ˜¯å¦éœ€è¦çµæŸå°è©±ä¸¦è¦æ±‚è¯çµ¡è³‡è¨Š
          if (response.shouldRequestContact) {
            conversationEnded = true;
            setTimeout(() => {
              const contactMessage = "è«‹å‘Šè¨´æˆ‘æ‚¨çš„å…¬å¸åç¨±åŠè¯çµ¡æ–¹å¼ï¼Œæˆ‘å€‘æœƒæœ‰å°ˆäººèˆ‡æ‚¨è¯ç¹«ï¼";
              addMessage(contactMessage, 'assistant');
              chatHistory.push({ role: 'assistant', content: contactMessage });
            }, 1000);
          }
          
          // æ»¾å‹•åˆ°åº•éƒ¨
          scrollToBottom();
        } else {
          addMessage('âŒ æŠ±æ­‰ï¼Œç³»çµ±æš«æ™‚ç„¡æ³•å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'assistant');
        }
      } catch (error) {
        hideLoading();
        addMessage('âŒ é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚', 'assistant');
      }
      
      isProcessing = false;
    }

    // æ·»åŠ è¨Šæ¯åˆ°èŠå¤©å®¹å™¨
    function addMessage(content, type) {
      const chatContainer = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}-message`;
      messageDiv.innerHTML = content.replace(/\n/g, '<br>');
      chatContainer.appendChild(messageDiv);
      scrollToBottom();
    }

    // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
    function showLoading() {
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'loadingMessage';
      loadingDiv.className = 'message assistant-message loading';
      loadingDiv.innerHTML = `
        <span>å®¢æœæ€è€ƒä¸­</span>
        <div class="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      `;
      document.getElementById('chatContainer').appendChild(loadingDiv);
      scrollToBottom();
    }

    // éš±è—è¼‰å…¥å‹•ç•«
    function hideLoading() {
      const loading = document.getElementById('loadingMessage');
      if (loading) loading.remove();
    }

    // æ»¾å‹•åˆ°åº•éƒ¨
    function scrollToBottom() {
      const container = document.getElementById('chatContainer');
      container.scrollTop = container.scrollHeight;
    }

    // è™•ç† Enter éµ
    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    // ç™¼é€è«‹æ±‚ (JSONP)
    function makeRequest(params) {
      return new Promise((resolve, reject) => {
        const callbackName = 'cb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        const script = document.createElement('script');
        
        const url = new URL(CONFIG.GAS_URL);
        url.searchParams.set('callback', callbackName);
        Object.keys(params).forEach(key => {
          url.searchParams.set(key, typeof params[key] === 'object' ? JSON.stringify(params[key]) : params[key]);
        });
        
        window[callbackName] = function(response) {
          delete window[callbackName];
          document.head.removeChild(script);
          resolve(response);
        };
        
        script.onerror = function() {
          delete window[callbackName];
          document.head.removeChild(script);
          reject(new Error('Network error'));
        };
        
        setTimeout(() => {
          if (window[callbackName]) {
            delete window[callbackName];
            document.head.removeChild(script);
            reject(new Error('Request timeout'));
          }
        }, 30000);
        
        script.src = url.toString();
        document.head.appendChild(script);
      });
    }

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    window.onload = function() {
      initSession();
      document.getElementById('userInput').focus();
    };
  </script>
</body>
</html>
